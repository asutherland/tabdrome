# Rules #

## Overview ##

We use https://github.com/CacheControl/json-rules-engine/ as the rules engine.
It's a simple rules engine that was chosen because:
* Actively developed.
* It includes quite nice documentation and examples.
* Explicitly avoids use of eval() and the rules are defined as inert JSON-able
  objects, not function closures.
* Its choice of a simple engine that can explain why rules failed to apply suits
  Tabdrome's needs and plans well and can always be optimized.  I'd originally
  considered using Datalog via DataScript for use cases like tabdrome or
  messaging client uses.  Given that our tabs can largely be considered in
  isolation and it's a specific goal to make share-able goals, I think a simple
  rules engine that is able to cache its results at each stage is not only
  sufficient but desirable.  (Which is not to say there isn't a place for
  datalog in the realm of tabdrome.  I believe the Tofino spin-off project
  Mentat is a very promising store in this space that is targeted at being a
  bookmarks/history/Places replacement.  Tabdrome can absolutely leverage such
  a history store when it's built into Gecko/Servo.)

## Rule Mappings ##

Currently we expect all rules to be generated by our blockly-based editor UI and
that we will be able to round-trip them.  This drives our decision of how to
expose things.

### Exposed Facts ###

#### Tabs ####

For each of "tab", "sessionRootTab", "ancestors":
* `tags`: Array of tag names without their sources.  This allows us to match tags
  where the "any" source has been chosen.
* `tagsWithSources`: Array of tag names with the tag name prefixed by the tag
  source identifier and a '!'.  So that might be "tab-badge!sweet" for the tag
  "sweet".  Sources are:
  * `tab`: Direct mapping of things on the normTab derived from the browser.tabs
    API.
  * `analysis`: An analysis rule did it!
  * `tab-badge`: The tab was explicitly badged via action.
  * `url-badge`: The tab's contents were badged via some site metadata set via
    action against the URL.
* `url`: Includes the following:
  * `lowercaseHostname`: The parsed, lower-cased hostname.
  * `pathTraces`: Because there's only string equality testing, given the path
    '/foo/bar/baz.blah', we will generate the output strings ['/foo',
    '/foo/bar', '/foo/bar/baz.blah'], allowing path-aware checks like this.
    And for '/foo/bar/' we generate ['/foo', '/foo/bar', '/foo/bar/'].

##### Synthetic Tab Tags #####



#### Buckets ####
